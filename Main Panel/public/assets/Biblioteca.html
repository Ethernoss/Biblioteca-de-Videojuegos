<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Library</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../src/styles/styleslibrary.css" />
  </head>
  <body class="bg-dark text-white">
    <!-- Navbar Superior -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand">🎮 Steam 2</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/store">STORE</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active">LIBRARY</a>
            </li>
          </ul>
          <!-- Barra de búsqueda -->
          <div class="inputbox">
            <input required="required" type="text" />
            <span>Search</span>
            <i></i>
          </div>
          <ul class="navbar-nav">
            <li class="nav-item">
              <!-- Boton para cerrar sesión -->
              <div class="dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  role="button"
                  id="userDropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  USER
                </a>
                <ul
                  class="dropdown-menu dropdown-menu-end"
                  aria-labelledby="userDropdown"
                >
                  <li>
                    <button id="logoutBtn" class="dropdown-item">
                      Cerrar sesión
                    </button>
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- Barra lateral -->
        <nav class="col-md-3 col-lg-2 sidebar p-3">
          <h5 class="text-light mb-4">Categories</h5>
          <ul class="nav flex-column">
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">All</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Action</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Adventure</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">RPG</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Shooter</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Strategy</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Simulation</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Sports</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Racing</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Puzzle</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Platformer</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Fighting</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Horror</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Survival</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">MMO</a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link text-white" href="#">Indie</a>
            </li>
          </ul>
        </nav>

        <!-- Contenido Principal -->
        <main class="col-md-9 col-lg-10 px-4">
          <!-- Encabezado con Filtros -->
          <header
            class="d-flex justify-content-between align-items-center my-3"
          >
            <h4 class="text-light mb-0">Todos los juegos</h4>
            <div class="d-flex gap-2">
              <div class="dropdown">
                <button
                  class="btn btn-primary dropdown-toggle shadow__btn"
                  type="button"
                  id="sortDropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Ordenar por:
                </button>
                <ul
                  class="dropdown-menu dropdown-menu-dark"
                  id="categoryDropdown"
                  aria-labelledby="sortDropdown"
                >
                  <li><a class="dropdown-item">All</a></li>
                  <li><a class="dropdown-item">Action</a></li>
                  <li><a class="dropdown-item">Adventure</a></li>
                  <li><a class="dropdown-item">RPG</a></li>
                  <li><a class="dropdown-item">Shooter</a></li>
                  <li><a class="dropdown-item">Strategy</a></li>
                  <li><a class="dropdown-item">Simulation</a></li>
                  <li><a class="dropdown-item">Sports</a></li>
                  <li><a class="dropdown-item">Racing</a></li>
                  <li><a class="dropdown-item">Puzzle</a></li>
                  <li><a class="dropdown-item">Platformer</a></li>
                  <li><a class="dropdown-item">Fighting</a></li>
                  <li><a class="dropdown-item">Horror</a></li>
                  <li><a class="dropdown-item">Survival</a></li>
                  <li><a class="dropdown-item">MMO</a></li>
                  <li><a class="dropdown-item">Indie</a></li>
                </ul>
              </div>
            </div>
          </header>

          <!-- Grilla de Juegos -->
          <div id="gamesGrid" class="row">
            <!-- Aquí se cargarán los juegos -->
          </div>
        </main>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../src/services/libraryService.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const response = await fetch("http://localhost:3000/library", {
            method: "GET",
            credentials: "include", // Incluir cookies en la solicitud
          });

          if (!response.ok) {
            throw new Error("Acceso denegado. Por favor, inicia sesión.");
          }

          console.log("Acceso concedido a la biblioteca");
        } catch (error) {
          console.error("Error al validar sesión:", error.message);
          alert(error.message);
          window.location.href = "/login";
        }
      });
    </script>
    <script>
      const gamesGrid = document.getElementById("gamesGrid");
      const categoryDropdown = document.getElementById("categoryDropdown");
      const categoryList = document.getElementById("categoryList");
      const searchInput = document.querySelector(".inputbox input");

      // Función para cargar todos los juegos cuando se abre la página
      const loadAllGames = async () => {
        try {
          const response = await fetch(
            "http://localhost:3000/api/personalGames"
          ); // Endpoint para obtener todos los juegos
          if (!response.ok) throw new Error("Error al obtener los juegos");

          const games = await response.json();
          gamesGrid.innerHTML = ""; // Limpiar la grilla

          // Inserta los juegos en la grilla
          games.forEach((game) => {
            const gameCard = `
              <div class="col-sm-6 col-md-4 col-lg-3 mb-4">
                <div class="card text-dark">
                  <img src="${game.image}" class="card-img-top" alt="${game.title}">
                  <div class="card-body">
                    <h6 class="card-title text-center">${game.title}</h6>
                    <p class="text-center">$${game.price}</p>
                  </div>
                </div>
              </div>
            `;
            gamesGrid.innerHTML += gameCard;
          });
        } catch (error) {
          console.error("Error al cargar los juegos:", error.message);
          gamesGrid.innerHTML =
            "<p class='text-center text-danger'>Error al cargar los juegos.</p>";
        }
      };

      // Cargar los juegos al abrir la ventana
      window.addEventListener("load", loadAllGames);

      categoryDropdown.addEventListener("change", async () => {
        const selectedCategory = categoryDropdown.value;

        // Limpia la grilla de juegos
        gamesGrid.innerHTML = "";
        console.log(selectedCategory);
        if (selectedCategory) {
          try {
            const token = localStorage.getItem("token"); // Obtener el token almacenado en el cliente

            if (!token) {
              throw new Error("Token no disponible en el cliente.");
            }

            const response = await fetch(
              "http://localhost:3000/api/gamesCategoriesPersonal",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ data: [selectedCategory], token }), // Enviar categoría y token
              }
            );

            if (!response.ok) throw new Error("Error al obtener los juegos");

            const games = await response.json();
            console.log(games);

            // Inserta los juegos en el HTML
            games.forEach((game) => {
              const gameCard = `
                <div class="col-sm-6 col-md-4 col-lg-3 mb-4">
                  <div class="card text-dark">
                    <img src="${game.image}" class="card-img-top" alt="${game.title}">
                    <div class="card-body">
                      <h6 class="card-title text-center">${game.title}</h6>
                      <p class="text-center">$${game.price}</p>
                    </div>
                  </div>
                </div>
              `;
              gamesGrid.innerHTML += gameCard;
            });
          } catch (error) {
            console.error("Error al cargar los juegos:", error.message);
            gamesGrid.innerHTML =
              "<p class='text-center text-danger'>Error al cargar los juegos.</p>";
          }
        } else if (selectedCategory === "All") {
          console.log("Asd");
          loadAllGames();
        }
      });
    </script>
    <script>
      // Botón de cerrar sesión
      const logoutBtn = document.getElementById("logoutBtn");

      logoutBtn.addEventListener("click", async () => {
        try {
          const response = await fetch("/api/logout", {
            method: "POST",
            credentials: "include", // Incluir cookies en la solicitud
          });

          if (response.ok) {
            localStorage.setItem("token", ""); // Limpiar el token almacenado
            Swal.fire({
              icon: "success",
              title: "Sesión cerrada",
              text: "Has cerrado sesión exitosamente",
            }).then(() => {
              window.location.href = "/login"; // Redirige al login después de cerrar sesión
            });
          } else {
            const { message } = await response.json();
            alert(`Error: ${message}`);
          }
        } catch (error) {
          console.error("Error al cerrar sesión:", error);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "Hubo un error al intentar cerrar sesión",
          });
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </body>
</html>

<!--  <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");
        console.log("Token recuperado del localStorage:", token);

        if (!token) {
          alert("Acceso denegado. Por favor, inicia sesión.");
          window.location.href = "/login";
          return;
        }

        try {
          const response = await fetch("http://localhost:3000/library", {
            method: "GET",
            headers: headers({
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            }),
          });

          console.log("Encabezados enviados:", {
            Authorization: `Bearer ${token}`,
          });

          if (!response.ok) {
            throw new Error("Acceso denegado. Por favor, inicia sesión.");
          }

          console.log("Acceso concedido a /library");
        } catch (error) {
          console.error("Error al acceder a /library:", error.message);
          alert(error.message);
          window.location.href = "/login";
        }
      });
    </script> -->
